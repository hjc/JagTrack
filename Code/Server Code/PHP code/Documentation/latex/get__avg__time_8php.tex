\hypertarget{get__avg__time_8php}{
\section{get\_\-avg\_\-time.php File Reference}
\label{get__avg__time_8php}\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}}
}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{get__avg__time_8php_abbac276c7f4e5bdd57c7e02000863656_abbac276c7f4e5bdd57c7e02000863656}{get\_\-avg\_\-time} (\$stop\_\-id, \$route\_\-id, \$mysqli)
\begin{DoxyCompactList}\small\item\em Queries the database and gets the average time it takes to get to a stop, assuming the bus is coming from the stop directly before this one. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{get__avg__time_8php_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0}{\$buses} = array()
\item 
\hyperlink{get__avg__time_8php_a2698dc52f06950fcdbaca1e94f88c1ff_a2698dc52f06950fcdbaca1e94f88c1ff}{\$done} = FALSE
\item 
\hyperlink{get__avg__time_8php_a22377fbdee6b0aad7e6e4b043f2b6603_a22377fbdee6b0aad7e6e4b043f2b6603}{\$envjson} = json\_\-decode(file\_\-get\_\-contents(\char`\"{}/home/dotcloud/environment.json\char`\"{}),true)
\item 
\hyperlink{get__avg__time_8php_a580989e8e3521433691a0351287f6315_a580989e8e3521433691a0351287f6315}{\$mysqli}
\item 
\hyperlink{get__avg__time_8php_a531a3cdb9017f75f6acb74a688f1ceeb_a531a3cdb9017f75f6acb74a688f1ceeb}{\$q\_\-bus}
\item 
\hyperlink{get__avg__time_8php_a49a8a4009b02e49717caa88b128affc5_a49a8a4009b02e49717caa88b128affc5}{\$res} = \$mysqli-\/$>$query(\$q\_\-bus)
\item 
\hyperlink{get__avg__time_8php_a053b1e7578c0ad2a0dd68068b071f3ed_a053b1e7578c0ad2a0dd68068b071f3ed}{\$route\_\-id} = \$\_\-GET\mbox{[}'r'\mbox{]}
\item 
\hyperlink{get__avg__time_8php_addc5e9981ac50c577e366f562a9382fe_addc5e9981ac50c577e366f562a9382fe}{\$stop\_\-id} = \$\_\-GET\mbox{[}'s'\mbox{]}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{get__avg__time_8php_abbac276c7f4e5bdd57c7e02000863656_abbac276c7f4e5bdd57c7e02000863656}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!get\_\-avg\_\-time@{get\_\-avg\_\-time}}
\index{get\_\-avg\_\-time@{get\_\-avg\_\-time}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{get\_\-avg\_\-time}]{\setlength{\rightskip}{0pt plus 5cm}get\_\-avg\_\-time (
\begin{DoxyParamCaption}
\item[{\$}]{stop\_\-id, }
\item[{\$}]{route\_\-id, }
\item[{\$}]{mysqli}
\end{DoxyParamCaption}
)}}
\label{get__avg__time_8php_abbac276c7f4e5bdd57c7e02000863656_abbac276c7f4e5bdd57c7e02000863656}


Queries the database and gets the average time it takes to get to a stop, assuming the bus is coming from the stop directly before this one. 


\begin{DoxyParams}[1]{Parameters}
int & {\em \$stop\_\-id} & ID for the stop we want the average time of, if we want to know how long it takes for a bus to go from stop 2 to stop 3 on route 1, we would pass in 3 (average time to get to stop 3).\\
\hline
int & {\em \$route\_\-id} & Stops can have multiple routes, use this to ensure we pull right time.\\
\hline
mysqli & {\em \$mysqli} & Already made mysqli object that is connected to dotCloud DB (making it is a mild pain).\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
null$|$avg\_\-time\_\-to\_\-next\_\-stop Returns either an integer which represents the average time it will take for a bus, on the specified route, to get to the specified stop (in minutes) or returns NULL if query failed. 
\end{DoxyReturn}


Definition at line 41 of file get\_\-avg\_\-time.php.



References \$mysqli, \$route\_\-id, and \$stop\_\-id.


\begin{DoxyCode}
                                                        {
        //figure out avg time for this piece of the route
        $q_r = sprintf("
            SELECT 
                avg_time_to_next_stop 
            FROM jt_route_stop
            WHERE next_stop_id = '%s'
            AND route_id = '%s'",
            $stop_id,
            $route_id);
        $res_avg_time = $mysqli->query($q_r);

        //see if query worked
        if ($route = $res_avg_time->fetch_object()) {
            return $route->avg_time_to_next_stop;
        }
        else {
            return NULL;
        }
    }

//# Import environment settings from DotCloud
    $envjson = json_decode(file_get_contents("/home/dotcloud/environment.json"),t
      rue);

    //get http vars
    $stop_id = $_GET['s'];
    $route_id = $_GET['r'];

    // Create MySQL Connection
    $mysqli = new mysqli($envjson['DOTCLOUD_DB_MYSQL_HOST'],
                     'someuser',         # username
                     'somepass',        # password
                     'jagtrack',        # db name
                     $envjson['DOTCLOUD_DB_MYSQL_PORT']);
    
    //query for buses on this route
    $q_bus = sprintf("SELECT * FROM jt_bus WHERE current_route_id = '%s'",
      $route_id);
    $res = $mysqli->query($q_bus);
    
    
    $buses = array();
    
    //bool for later logic
    $done = FALSE;
    
    //get those buses!
    while ($b = $res->fetch_object()) {
        //if this bus is going to the next stop, then we're done!
        if ($b->next_stop_id == $stop_id) {
            //indicate we're done
            $done = TRUE;
            
            //figure out avg time for this piece of the route
            $avg = get_avg_time($stop_id, $route_id, $mysqli);
            
            //see if query worked
            if ($avg !== NULL) {
                print(json_encode($avg));
            }
            else {
                //throw error
                print('error!!!');
            }       
        }
        
        //add bus to array
        $buses[] = $b;
    }
    
    //if not done, "climb the bridge table" until we can get an accurate avg
    //time
    if (! $done) {
        
        //get every stop on this route
        $get_bridge = sprintf("SELECT * FROM jt_route_stop WHERE route_id = '%s'"
      ,
          $route_id);
        $bridge_res = $mysqli->query($get_bridge);
        
        //store stops in an array
        $stops = array();
        while ($stop = $bridge_res->fetch_object()) {
            $stops[] = $stop;
        }
        
        //set stop we want
        $desired_stop_id = $stop_id;
        $avg = 0;
        
        $done = FALSE;
        
        //do logic
        while (! $done) {
            
            //see what 
            for ($i = 0; $i < count($stops); $i++) {
                
                //this is the previous stop in the chain! look for a bus going
                //here and stop 
                if ($stops[$i]->next_stop_id == $desired_stop_id) {
                    //increment average
                    $avg += $stops[$i]->avg_time_to_next_stop;
                    
                    //go through every bus
                    for ($j = 0; $j < count($buses); $j++) {
                        
                        //if bus' next stop id is the one we want, we can stop
                        //after this
                        if ($buses[$j]->next_stop_id == $desired_stop_id) {
                            $done = TRUE;
                            break;
                        }
                    }
                    if ($done) {
                        break;
                    }
                    
                    //change the desired stop id
                    $desired_stop_id = $stops[$i]->stop_id;
                }
            }
        }
        //print the data
        print(json_encode($avg));
    }
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{get__avg__time_8php_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$buses@{\$buses}}
\index{\$buses@{\$buses}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$buses}]{\setlength{\rightskip}{0pt plus 5cm}\$buses = array()}}
\label{get__avg__time_8php_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0}


Definition at line 82 of file get\_\-avg\_\-time.php.

\hypertarget{get__avg__time_8php_a2698dc52f06950fcdbaca1e94f88c1ff_a2698dc52f06950fcdbaca1e94f88c1ff}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$done@{\$done}}
\index{\$done@{\$done}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$done}]{\setlength{\rightskip}{0pt plus 5cm}\$done = FALSE}}
\label{get__avg__time_8php_a2698dc52f06950fcdbaca1e94f88c1ff_a2698dc52f06950fcdbaca1e94f88c1ff}


Definition at line 85 of file get\_\-avg\_\-time.php.

\hypertarget{get__avg__time_8php_a22377fbdee6b0aad7e6e4b043f2b6603_a22377fbdee6b0aad7e6e4b043f2b6603}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$envjson@{\$envjson}}
\index{\$envjson@{\$envjson}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$envjson}]{\setlength{\rightskip}{0pt plus 5cm}\$envjson = json\_\-decode(file\_\-get\_\-contents(\char`\"{}/home/dotcloud/environment.json\char`\"{}),true)}}
\label{get__avg__time_8php_a22377fbdee6b0aad7e6e4b043f2b6603_a22377fbdee6b0aad7e6e4b043f2b6603}


Definition at line 63 of file get\_\-avg\_\-time.php.

\hypertarget{get__avg__time_8php_a580989e8e3521433691a0351287f6315_a580989e8e3521433691a0351287f6315}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$mysqli@{\$mysqli}}
\index{\$mysqli@{\$mysqli}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$mysqli}]{\setlength{\rightskip}{0pt plus 5cm}\$mysqli}}
\label{get__avg__time_8php_a580989e8e3521433691a0351287f6315_a580989e8e3521433691a0351287f6315}
{\bfseries Initial value:}
\begin{DoxyCode}
 new mysqli($envjson['DOTCLOUD_DB_MYSQL_HOST'],
                     'someuser',         # username
                     'somepass',        # password
                     'jagtrack',        # db name
                     $envjson['DOTCLOUD_DB_MYSQL_PORT'])
\end{DoxyCode}


Definition at line 70 of file get\_\-avg\_\-time.php.



Referenced by get\_\-avg\_\-time(), and get\_\-bus\_\-avg().

\hypertarget{get__avg__time_8php_a531a3cdb9017f75f6acb74a688f1ceeb_a531a3cdb9017f75f6acb74a688f1ceeb}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$q\_\-bus@{\$q\_\-bus}}
\index{\$q\_\-bus@{\$q\_\-bus}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$q\_\-bus}]{\setlength{\rightskip}{0pt plus 5cm}\$q\_\-bus}}
\label{get__avg__time_8php_a531a3cdb9017f75f6acb74a688f1ceeb_a531a3cdb9017f75f6acb74a688f1ceeb}
{\bfseries Initial value:}
\begin{DoxyCode}
 sprintf("SELECT * FROM jt_bus WHERE current_route_id = '%s'",
      $route_id)
\end{DoxyCode}


Definition at line 77 of file get\_\-avg\_\-time.php.

\hypertarget{get__avg__time_8php_a49a8a4009b02e49717caa88b128affc5_a49a8a4009b02e49717caa88b128affc5}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$res@{\$res}}
\index{\$res@{\$res}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$res}]{\setlength{\rightskip}{0pt plus 5cm}\$res = \$mysqli-\/$>$query(\$q\_\-bus)}}
\label{get__avg__time_8php_a49a8a4009b02e49717caa88b128affc5_a49a8a4009b02e49717caa88b128affc5}


Definition at line 79 of file get\_\-avg\_\-time.php.

\hypertarget{get__avg__time_8php_a053b1e7578c0ad2a0dd68068b071f3ed_a053b1e7578c0ad2a0dd68068b071f3ed}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$route\_\-id@{\$route\_\-id}}
\index{\$route\_\-id@{\$route\_\-id}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$route\_\-id}]{\setlength{\rightskip}{0pt plus 5cm}\$route\_\-id = \$\_\-GET\mbox{[}'r'\mbox{]}}}
\label{get__avg__time_8php_a053b1e7578c0ad2a0dd68068b071f3ed_a053b1e7578c0ad2a0dd68068b071f3ed}


Definition at line 67 of file get\_\-avg\_\-time.php.



Referenced by get\_\-avg\_\-time(), and get\_\-bus\_\-avg().

\hypertarget{get__avg__time_8php_addc5e9981ac50c577e366f562a9382fe_addc5e9981ac50c577e366f562a9382fe}{
\index{get\_\-avg\_\-time.php@{get\_\-avg\_\-time.php}!\$stop\_\-id@{\$stop\_\-id}}
\index{\$stop\_\-id@{\$stop\_\-id}!get_avg_time.php@{get\_\-avg\_\-time.php}}
\subsubsection[{\$stop\_\-id}]{\setlength{\rightskip}{0pt plus 5cm}\$stop\_\-id = \$\_\-GET\mbox{[}'s'\mbox{]}}}
\label{get__avg__time_8php_addc5e9981ac50c577e366f562a9382fe_addc5e9981ac50c577e366f562a9382fe}


Definition at line 66 of file get\_\-avg\_\-time.php.



Referenced by get\_\-avg\_\-time(), and get\_\-bus\_\-avg().

