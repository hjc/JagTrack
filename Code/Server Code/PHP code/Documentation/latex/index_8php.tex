\hypertarget{index_8php}{
\section{index.php File Reference}
\label{index_8php}\index{index.php@{index.php}}
}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{index_8php_ab3b9e6b803a65641a6cbc175205a076f_ab3b9e6b803a65641a6cbc175205a076f}{get\_\-bus\_\-avg} (\$stop\_\-id, \$route\_\-id, \$mysqli)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{index_8php_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0}{\$buses} = array()
\item 
\hyperlink{index_8php_a2698dc52f06950fcdbaca1e94f88c1ff_a2698dc52f06950fcdbaca1e94f88c1ff}{\$done} = FALSE
\item 
\hyperlink{index_8php_a22377fbdee6b0aad7e6e4b043f2b6603_a22377fbdee6b0aad7e6e4b043f2b6603}{\$envjson} = json\_\-decode(file\_\-get\_\-contents(\char`\"{}/home/dotcloud/environment.json\char`\"{}),true)
\item 
\hyperlink{index_8php_a580989e8e3521433691a0351287f6315_a580989e8e3521433691a0351287f6315}{\$mysqli}
\item 
\hyperlink{index_8php_a531a3cdb9017f75f6acb74a688f1ceeb_a531a3cdb9017f75f6acb74a688f1ceeb}{\$q\_\-bus}
\item 
\hyperlink{index_8php_a49a8a4009b02e49717caa88b128affc5_a49a8a4009b02e49717caa88b128affc5}{\$res} = \$mysqli-\/$>$query(\$q\_\-bus)
\item 
\hyperlink{index_8php_a053b1e7578c0ad2a0dd68068b071f3ed_a053b1e7578c0ad2a0dd68068b071f3ed}{\$route\_\-id} = \$\_\-GET\mbox{[}'r'\mbox{]}
\item 
\hyperlink{index_8php_addc5e9981ac50c577e366f562a9382fe_addc5e9981ac50c577e366f562a9382fe}{\$stop\_\-id} = \$\_\-GET\mbox{[}'s'\mbox{]}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{index_8php_ab3b9e6b803a65641a6cbc175205a076f_ab3b9e6b803a65641a6cbc175205a076f}{
\index{index.php@{index.php}!get\_\-bus\_\-avg@{get\_\-bus\_\-avg}}
\index{get\_\-bus\_\-avg@{get\_\-bus\_\-avg}!index.php@{index.php}}
\subsubsection[{get\_\-bus\_\-avg}]{\setlength{\rightskip}{0pt plus 5cm}get\_\-bus\_\-avg (
\begin{DoxyParamCaption}
\item[{\$}]{stop\_\-id, }
\item[{\$}]{route\_\-id, }
\item[{\$}]{mysqli}
\end{DoxyParamCaption}
)}}
\label{index_8php_ab3b9e6b803a65641a6cbc175205a076f_ab3b9e6b803a65641a6cbc175205a076f}


Definition at line 2 of file index.php.



References \$mysqli, \$route\_\-id, and \$stop\_\-id.


\begin{DoxyCode}
                                                       {
        //figure out avg time for this piece of the route
        $q_r = sprintf("
            SELECT 
                avg_time_to_next_stop 
            FROM jt_route_stop
            WHERE next_stop_id = '%s'
            AND route_id = '%s'",
            $stop_id,
            $route_id);
        $res_avg_time = $mysqli->query($q_r);

        //see if query worked
        if ($route = $res_avg_time->fetch_object()) {
            return $route->avg_time_to_next_stop;
        }
        else {
            return NULL;
        }
    }

//# Import environment settings from DotCloud
    $envjson = json_decode(file_get_contents("/home/dotcloud/environment.json"),t
      rue);

    //get http vars
    $stop_id = $_GET['s'];
    $route_id = $_GET['r'];

    // Create MySQL Connection
    $mysqli = new mysqli($envjson['DOTCLOUD_DB_MYSQL_HOST'],
                     'hjc1710',         # username
                     's1lw2y44',        # password
                     'jagtrack',        # db name
                     $envjson['DOTCLOUD_DB_MYSQL_PORT']);
    
    //query for buses on this route
    $q_bus = sprintf("SELECT * FROM jt_bus WHERE current_route_id = '%s'",
      $route_id);
    $res = $mysqli->query($q_bus);
    
    
    $buses = array();
    
    //bool for later logic
    $done = FALSE;
    
    //get those buses!
    while ($b = $res->fetch_object()) {
        //if this bus is going to the next stop, then we're done!
        if ($b->next_stop_id == $stop_id) {
            //indicate we're done
            $done = TRUE;
            
            //figure out avg time for this piece of the route
            $avg = get_bus_avg($stop_id, $route_id, $mysqli);
            
            //see if query worked
            if ($avg !== NULL) {
                print(json_encode($avg));
            }
            else {
                //throw error
                print('error!!!');
            }       
        }
        
        //add bus to array
        $buses[] = $b;
    }
    
    //if not done, "climb the bridge table" until we can get an accurate avg
    //time
    if (! $done) {
        
        //get every stop on this route
        $get_bridge = sprintf("SELECT * FROM jt_route_stop WHERE route_id = '%s'"
      ,
          $route_id);
        $bridge_res = $mysqli->query($get_bridge);
        
        //store stops in an array
        $stops = array();
        while ($stop = $bridge_res->fetch_object()) {
            $stops[] = $stop;
        }
        
        //set stop we want
        $desired_stop_id = $stop_id;
        $avg = 0;
        
        $done = FALSE;
        
        //do logic
        while (! $done) {
            
            //see what 
            for ($i = 0; $i < count($stops); $i++) {
                
                //this is the previous stop in the chain! look for a bus going
                //here and
                if ($stops[$i]->next_stop_id == $desired_stop_id) {
                    //print 'in if';
                    $avg += $stops[$i]->avg_time_to_next_stop;
                    //print $avg; print '<br>';
                    
                    //print_r($stops[$i]);
                    
                    //print '<br>';
                    
                    for ($j = 0; $j < count($buses); $j++) {
                        //print_r($buses[$j]);
                        //print "<br>";
                        if ($buses[$j]->next_stop_id == $desired_stop_id) {
                            //print "breaking<br>";
                            //print json_encode($buses[$j]);
                            $done = TRUE;
                            break;
                        }
                    }
                    
                    if ($done) {
                        break;
                    }
                    
                    $desired_stop_id = $stops[$i]->stop_id;
                }
            }
        }
        print(json_encode($avg));
    }
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{index_8php_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0}{
\index{index.php@{index.php}!\$buses@{\$buses}}
\index{\$buses@{\$buses}!index.php@{index.php}}
\subsubsection[{\$buses}]{\setlength{\rightskip}{0pt plus 5cm}\$buses = array()}}
\label{index_8php_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0_ae7ef8ab0940cf7a7e9a8a2bb0f3b47b0}


Definition at line 43 of file index.php.

\hypertarget{index_8php_a2698dc52f06950fcdbaca1e94f88c1ff_a2698dc52f06950fcdbaca1e94f88c1ff}{
\index{index.php@{index.php}!\$done@{\$done}}
\index{\$done@{\$done}!index.php@{index.php}}
\subsubsection[{\$done}]{\setlength{\rightskip}{0pt plus 5cm}\$done = FALSE}}
\label{index_8php_a2698dc52f06950fcdbaca1e94f88c1ff_a2698dc52f06950fcdbaca1e94f88c1ff}


Definition at line 46 of file index.php.

\hypertarget{index_8php_a22377fbdee6b0aad7e6e4b043f2b6603_a22377fbdee6b0aad7e6e4b043f2b6603}{
\index{index.php@{index.php}!\$envjson@{\$envjson}}
\index{\$envjson@{\$envjson}!index.php@{index.php}}
\subsubsection[{\$envjson}]{\setlength{\rightskip}{0pt plus 5cm}\$envjson = json\_\-decode(file\_\-get\_\-contents(\char`\"{}/home/dotcloud/environment.json\char`\"{}),true)}}
\label{index_8php_a22377fbdee6b0aad7e6e4b043f2b6603_a22377fbdee6b0aad7e6e4b043f2b6603}


Definition at line 24 of file index.php.

\hypertarget{index_8php_a580989e8e3521433691a0351287f6315_a580989e8e3521433691a0351287f6315}{
\index{index.php@{index.php}!\$mysqli@{\$mysqli}}
\index{\$mysqli@{\$mysqli}!index.php@{index.php}}
\subsubsection[{\$mysqli}]{\setlength{\rightskip}{0pt plus 5cm}\$mysqli}}
\label{index_8php_a580989e8e3521433691a0351287f6315_a580989e8e3521433691a0351287f6315}
{\bfseries Initial value:}
\begin{DoxyCode}
 new mysqli($envjson['DOTCLOUD_DB_MYSQL_HOST'],
                     'hjc1710',         # username
                     's1lw2y44',        # password
                     'jagtrack',        # db name
                     $envjson['DOTCLOUD_DB_MYSQL_PORT'])
\end{DoxyCode}


Definition at line 31 of file index.php.

\hypertarget{index_8php_a531a3cdb9017f75f6acb74a688f1ceeb_a531a3cdb9017f75f6acb74a688f1ceeb}{
\index{index.php@{index.php}!\$q\_\-bus@{\$q\_\-bus}}
\index{\$q\_\-bus@{\$q\_\-bus}!index.php@{index.php}}
\subsubsection[{\$q\_\-bus}]{\setlength{\rightskip}{0pt plus 5cm}\$q\_\-bus}}
\label{index_8php_a531a3cdb9017f75f6acb74a688f1ceeb_a531a3cdb9017f75f6acb74a688f1ceeb}
{\bfseries Initial value:}
\begin{DoxyCode}
 sprintf("SELECT * FROM jt_bus WHERE current_route_id = '%s'",
      $route_id)
\end{DoxyCode}


Definition at line 38 of file index.php.

\hypertarget{index_8php_a49a8a4009b02e49717caa88b128affc5_a49a8a4009b02e49717caa88b128affc5}{
\index{index.php@{index.php}!\$res@{\$res}}
\index{\$res@{\$res}!index.php@{index.php}}
\subsubsection[{\$res}]{\setlength{\rightskip}{0pt plus 5cm}\$res = \$mysqli-\/$>$query(\$q\_\-bus)}}
\label{index_8php_a49a8a4009b02e49717caa88b128affc5_a49a8a4009b02e49717caa88b128affc5}


Definition at line 40 of file index.php.

\hypertarget{index_8php_a053b1e7578c0ad2a0dd68068b071f3ed_a053b1e7578c0ad2a0dd68068b071f3ed}{
\index{index.php@{index.php}!\$route\_\-id@{\$route\_\-id}}
\index{\$route\_\-id@{\$route\_\-id}!index.php@{index.php}}
\subsubsection[{\$route\_\-id}]{\setlength{\rightskip}{0pt plus 5cm}\$route\_\-id = \$\_\-GET\mbox{[}'r'\mbox{]}}}
\label{index_8php_a053b1e7578c0ad2a0dd68068b071f3ed_a053b1e7578c0ad2a0dd68068b071f3ed}


Definition at line 28 of file index.php.

\hypertarget{index_8php_addc5e9981ac50c577e366f562a9382fe_addc5e9981ac50c577e366f562a9382fe}{
\index{index.php@{index.php}!\$stop\_\-id@{\$stop\_\-id}}
\index{\$stop\_\-id@{\$stop\_\-id}!index.php@{index.php}}
\subsubsection[{\$stop\_\-id}]{\setlength{\rightskip}{0pt plus 5cm}\$stop\_\-id = \$\_\-GET\mbox{[}'s'\mbox{]}}}
\label{index_8php_addc5e9981ac50c577e366f562a9382fe_addc5e9981ac50c577e366f562a9382fe}


Definition at line 27 of file index.php.

